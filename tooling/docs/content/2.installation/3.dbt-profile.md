---
title: Connexion à la base de données
---

# "Je ne sais pas quoi faire !" : commençons par la base alors !
Jusqu'ici, nous n'avons pas connecté notre magasin à la base de données. Pour lier le magasin à la base de données et commencer à voir se matérialiser nos tables et nos vues, nous devons indiquer à  DBT où il doit regarder pour les informations d'identification des bases de données et celles de connexion. Nous le faisons en créant un fichier `dbt_profile.yml`.

## Mais qu'est-ce donc que ce  `dbt_profile.yml` ? 

::alert{type="info"}
tl;dr : DBT utilise un fichier `dbt_profile.yml` sauvegardé sous `~/.dbt/dbt_profile.yml` pour stocker les informations de connexion à la base de données. L'IP de la base de données et l'authentification de l'utilisateur sont présents dans le fichier `dbt_profile.yml`.
::

Le besoin d'avoir un fichier de profil DBT (profile file) vient du fait que dbt doit savoir où vos données sont stockées, comment s'y connecter et autres détails de configuration. En ayant un fichier de configuration centralisé, vous pouvez gérer ces paramètres à un endroit et passer d'un environnement à l'autre (ex: dev, prod, staging) sans modifier vos modèles dbt.

Certains éléments importants qui se retrouvent dans un fichier de profil DBT:
1. Détails des informations de connexion à la base de données: cela inclut des informations dont le type de base de données (ex: BigQuery, Snowflake, Redshift, SQL Server), l'hôte, le nom de la base de données, le schéma et les détails de l'authentification.
2. Profils: vous pouvez définir différents profils dans le fichier. Cela vous permettra de changer d'environnement ou d'entrepôt de données facilement.

Bref, le fichier de profil DBT est essentiel à la configuration et à la connexion de dbt à votre entrepôt de données, simplifiant les processus de transformation de données.

Ce fichier **n'est pas** situé dans le projet en soi, car il contient des données d'authentification qui ne doivent pas se retrouver dans le Git. Il est plutôt habituellement situé dans le dossier `~/.dbt`. 

## Comment DBT saura quel profil utiliser ?

::alert{type="info"}
tl;dr : La clé `profile`, en-haut de `cssXX.dashboards_store/dbt_project.yml` fait référence au nom du profil que vous voulez utiliser, en provenance du fichier `~/.dbt/dbt_profile.yml`. 
::

Quand vous roulez une commande DBT dans un projet spécifique, DBT détermine quel profil utiliser en se basant sur la configuration spécifiée dans le fichier `profiles.yml`. Le fichier `profiles.yml` se situe dans le dossier `~/.dbt/`.

Voilà comment DBT sait quel profil utiliser dans un projet spécifique :

1. **Profil par défaut:**
   - Si vous avez un seul profil dans votre fichier `profiles.yml`, DBT utilisera ce profil par défaut. Ce sera le cas lorsque vous avez un seul environnement ou une seule connection à un entrepôt de données.

2. **Configuration du projet:**
   - Dans le fichier `dbt_project.yml`  à l'intérieur du répertoire de votre projet DBT, vous pouvez spécifier le profil à utiliser pour ce projet spécifique en utilisant la clé `profile`. Si la clé n'est pas définie, DBT utilisera votre profil par défaut du fichier `profiles.yml`.

Exemple `dbt_project.yml`:
```yaml
name: mon_projet
version: 1.0

profil: mon_profil_personnel
```

Dans cet exemple, DBT utilisera le profil qui s'appelle "mon_profil_personnel" pour le projet "mon_projet".

En fournissant l'information de profil soit par l'environnement de variable `DBT_PROFILE`, le paramètre `--profile` **mon_profil**, ou le fichier `dbt_project.yml`, vous pouvez indiquer à DBT quel profil utiliser pour ce projet spécifique.

## Quelle est la différence entre  `profile` et `target` ?

Dans le contexte de DBT, le profil et la cible ont différentes utilités :

1. Profile :

    * Un  `profile` DBT est un fichier de configuration s'appelant profiles.yml et contenant des informations sur la connexion à l'entrepôt de données.
    * Il inclut des détails dont le type de base de données,(ex: BigQuery, Snowflake, Redshift), l'hôte, le nom de la base de données, le schéma, et les détails d'authentification.
    * Vous pouvez définir plusieurs profils dans le fichier profiles.yml, vous permettant de configurer des connexions pour différents environnements (ex: dev, prod).
    * Les profils servent principalement à spécifier à dbt comment se connecter à un entrepôt de données.
    * **Le magasin des tableaux de bord ne devrait utiliser qu'un seul profil**

1. Target:
    * Un `target` DBT est un environnement spécifique ou déploiement de votre projet DBT.
    * Les `targets` sont des configurations pour rouler des commandes DBT dans un contexte spécifique, dont le développement ou la production.
    * Les `targets` sont souvent sprécifiés en utilisant --target **notre_target**, roulant des commandes DBT, permettant ainsi de passer d'un environnement à l'autre facilement.
    * Les `targets` peuvent se référer à des profils spécifiques parmi les fichiers profiles.yml, vous permettant d'utiliser différentes connexions à des entrepôts de données pour différents environnements.
    * Bref, un profil est une configuration globale pour connecter dbt à un entrepôt de données et il est défini dans le fichier profiles.yml. Un `target` quant à lui, est une configuration spécifique pour rouler DBT dans un contexte ou un environnement particulier. De plus, il peut se référer à un profil spécifique. Les cibles vous aident à gérer et à passer par différents environnements de déploiement pour votre projet DBT.


# J'ai saisi. J'ai besoin d'un profil. Pouvez-vous m'aider à commencer le processus ?
::alert{type="success"}
Il peut être lourd de configurer un profil. Heureusement, lorsque vous avez enclenché le `cssXX.dashboards_store`, vous avez  *en fait* créé un exemplaire de `profiles.yml` presque prêt à être utilisé.
::

Lorsque vous avez enclenché le `cssXX.dashboards_store`, vous avez été invité à inscrire certaines informations : 
* Quel est l'IP de votre base de données ?
* Quel est le port de votre base de données ?

Ces informations ont été utilisées pour créer un fichier `profiles.yml` que vous pouvez trouver sous `cssXX.dashboards_store/profiles-sample.yml`.

Vous devez maintenant remplir et déplacer votre `profiles-sample.yml`. Voici comment faire: 
1. Ajouter le mot de passe utilisateur de votre base de données pour vous y connecter : éditer le fichier `profiles-sample.yml`, et remplacer le `password: dontLookAtMeImSecret` par votre propre mot de passe utilisateur.
2. Déplacer le `profiles-sample.yml` vers `~/.dbt/profiles.yml` : 

```bash
mv profiles-sample.yml ~/.dbt/profiles.yml
```

::alert{type="danger"}
Si vous avez déjà utilisé DBT auparavant, vous avez un `~/.dbt/profiles.yml` de créé, il suffit alors de copier le contenu de `profiles-sample.yml` vers votre `~/.dbt/profiles.yml`.
::

# Pourquoi j'ai trois cibles (targets) dans mon `profiles.yml` ?

## Explication
Vous pouvez voir une cible comme un `environnement`. Les cibles permettent à DBT de gérer les différents environnements que vous pouvez avoir. La cible par défaut de `profiles.yml` est `dev`. Dev est configuré de façon à utiliser votre nom en tant que schéma, et il est la cible que vous allez principalement utiliser pour développer vos modèles. Puisqu'il utilise votre nom en tant que base pour  `database schema` , toutes les tables que vous matérialiserez et toute modification de code que vous ferez ne changera pas les matérialisations des autres personnes travaillant sur le même projet puisque leurs matérialisations vivront dans le schéma `dev` sous leur propre nom. En utilisant les `targets`, nous pouvons tous travailler sur le même projet, sur la même base de donneés, sans nous marcher sur les pieds.

## Environnement de simulation (staging) et de production
Les `profiles.yml` contiennent deux autres profils : 
1. **staging** : Le profil d'environnement de simulation est utilisé pour tester votre code avant de le déployer en production. Il s'agit d'une bonne pratique que de tester votre code avant de le déployer en production, puisque vous ne voulez pas défaire votre base de données de production. Le profil d'environnement de simulation est configuré pour utiliser le schéma `dbo` dans la base de données  `store_dev`. Vous pouvez utiliser le schéma d'environnement de simulation pour rouler le code pendant la nuit, et ainsi obtenir un aperçu avant de le rouler dans la base de données de production.
2. **prod** : Le profil prod est utilisé pour déployer votre code en production. Il est configuré de façon à utiliser le schéma `dbo` dans la base de données `store` . Vous ne devriez l'utiliser que lorsque vous vous êtes assurés que votre code fonctionne.

Idéalement, vos tableaux de bord **Power Bi** non déployés devraient être connectés à l'environnement `staging` , et ceux qui ont été déployés devraient être connectés à l'environnement `prod`. Ce faisant, vous pouvez tester certaines modifications aux tableaux de bord et aux scripts sans que cela n'affecte les autres utilisateurs.
